


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.1.7">
    
    
      
        <title>**Cert Manager** - Application Container Platform</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4c7052ca.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cert-manager" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Application Container Platform" class="md-header-nav__button md-logo" aria-label="Application Container Platform">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Application Container Platform
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              **Cert Manager**
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Application Container Platform" class="md-nav__button md-logo" aria-label="Application Container Platform">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Application Container Platform
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../index.html" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../services.html" title="Services" class="md-nav__link">
      Services
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://gitlab.digital.homeoffice.gov.uk/acp-docs/acp-support/tree/master/release-notes/" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="index.html" title="How To's" class="md-nav__link">
      How To's
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../developer-docs/index.html" title="Developer Getting Started Guide" class="md-nav__link">
      Developer Getting Started Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../newuser.html" title="New User Guide" class="md-nav__link">
      New User Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../rbac.html" title="RBAC Guide" class="md-nav__link">
      RBAC Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../external-addresses.html" title="ACP External IPs" class="md-nav__link">
      ACP External IPs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../service-lifecycle.html" title="Service Lifecycle" class="md-nav__link">
      Service Lifecycle
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#very-important-upgrade-information" class="md-nav__link">
    VERY IMPORTANT upgrade information
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-tos" class="md-nav__link">
    How-tos
  </a>
  
    <nav class="md-nav" aria-label="How-tos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#as-a-developer-i-already-have-a-certificate-from-the-legacy-kube-cert-manager-how-do-i-migrate" class="md-nav__link">
    As a developer I already have a certificate from the legacy kube-cert-manager, how do I migrate?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#as-a-developer-i-want-to-retrieve-an-internal-certificate" class="md-nav__link">
    As a developer I want to retrieve an internal certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#as-a-developer-i-want-to-retrieve-a-certificate-for-my-external-service" class="md-nav__link">
    As a developer I want to retrieve a certificate for my external service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#as-a-developer-i-want-to-retrieve-a-certificate-for-a-service-behind-the-vpn-or-simply-wish-to-use-the-dns-validation" class="md-nav__link">
    As a developer I want to retrieve a certificate for a service behind the vpn, or simply wish to use the DNS validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#as-a-developer-i-want-to-use-letsencrypt-staging-while-configuring-my-cert-manager-resources" class="md-nav__link">
    As a developer I want to use LetsEncrypt staging while configuring my cert-manager resources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#as-a-developer-i-want-to-get-a-certificate-for-a-server-with-a-dns-name-longer-than-63-characters" class="md-nav__link">
    As a developer I want to get a certificate for a server with a DNS name longer than 63 characters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="cert-manager"><strong>Cert Manager</strong><a class="headerlink" href="#cert-manager" title="Permanent link">#</a></h1>
<h2 id="very-important-upgrade-information">VERY IMPORTANT upgrade information<a class="headerlink" href="#very-important-upgrade-information" title="Permanent link">#</a></h2>
<p><code>cert-manager</code> is being upgraded from v0.8 to v0.13.1. If you have cert-manager resources deployed in your namespaces, you MUST follow the <a href="cert-manager-upgrade-from-v0.8.html">instructions to upgrade from v0.8</a> to upgrade annotations and labels in order for them to be managed by the new version of cert-manager.</p>
<p>To find out if you are using v0.8 cert-manager resources in your namespace, you can run:</p>
<pre><code>kubectl get certificates.certmanager.k8s.io
</code></pre>

<p>Also LetsEncrypt will no longer be supporting PSG's kube-cert-manager from June 2020. So if you are using PSG kube-cert-manager to obtain certificates for your ingresses, you also need to migrate to JetStack's cert-manager v0.13.1 and follow the <a href="cert-manager-upgrade-from-psg.html">instructions to upgrade from PGS's kube-cert-manager</a></p>
<p>To find out if you are using PSG kube-cert-manager to manage your ingresses certificates, you can run:</p>
<pre><code>kubectl get ingresses -o yaml | grep stable.k8s.psg.io
</code></pre>

<p>Please also be aware that admission policies have been updated and will reject <code>Ingress</code> resources with annotations or labels supported by more than one certificate manager. There are currently ingresses with both cert-manager v0.8 and PSG annotations or labels and those will now fail applying.</p>
<h2 id="background">Background<a class="headerlink" href="#background" title="Permanent link">#</a></h2>
<p>The ACP platform presently has two certificate management services.</p>
<p>The first service was PSG's <a href="https://github.com/PalmStoneGames/kube-cert-manager">kube-cert-manager</a>. However with the forever changing landscape the project gradually became deprecated and now recommends replacement with JetStack's <a href="https://github.com/jetstack/cert-manager">cert-manager</a>.</p>
<p>Therefore, projects still using kube-cert-manager should modify their services to start using cert-manager instead. Note that ACP will continue to support kube-cert-manager and the internal cfssl service while they are still in use, but we do recommend shifting over to cert-manager as soon as possible as aside from security fixes there will not be any more updates to these services.</p>
<p>Without wishing to duplicate documentation which can be found in the <a href="https://github.com/jetstack/cert-manager/blob/master/README.md">readme</a> and or official <a href="https://cert-manager.io/docs/">documentation</a>, cert-manager can effectively replace two services:</p>
<ul>
<li>kube-cert-manager: used to acquire certificates from LetsEncrypt.</li>
<li>cfssl: an internal Cloudflare service used to generate internal certificate <em>(usually to encrypt between ingress and pod)</em>.</li>
</ul>
<p><strong>IMPORTANT NOTE:</strong></p>
<p><code>cert-manager</code> is being upgraded from v0.8 to v0.13.1. In order to allow development teams to upgrade their <code>cert-manager</code> resources according to their own schedule, both v0.8 and v.13.1 resources will be available concurrently for a period of time.</p>
<p>While the older version of <code>cert-manager</code> (v0.8) is still available on the ACP platform, resources managed by the newer version of cert-manager (v0.13.1+) can only be accessed from the API server by suffixing the resource kind with <code>.cert-manager.io</code>.</p>
<p>For example:</p>
<pre><code># to access v0.13.1 cert-manager resources
kubectl -n project get certificate.cert-manager.io
kubectl -n project get orders.acme.cert-manager.io
kubectl -n project get challenge.acme.cert-manager.io
</code></pre>

<pre><code># to access v0.8 cert-manager resources
kubectl -n project get certificate
kubectl -n project get orders
kubectl -n project get challenge
# or
kubectl -n project get certificate.certmanager.k8s.io
kubectl -n project get orders.certmanager.k8s.io
kubectl -n project get challenge.certmanager.k8s.io
</code></pre>

<h2 id="how-tos"><strong>How-tos</strong><a class="headerlink" href="#how-tos" title="Permanent link">#</a></h2>
<h3 id="as-a-developer-i-already-have-a-certificate-from-the-legacy-kube-cert-manager-how-do-i-migrate"><strong>As a developer I already have a certificate from the legacy kube-cert-manager, how do I migrate?</strong><a class="headerlink" href="#as-a-developer-i-already-have-a-certificate-from-the-legacy-kube-cert-manager-how-do-i-migrate" title="Permanent link">#</a></h3>
<p>Migrating from the former <a href="https://github.com/PalmStoneGames/kube-cert-manager">kube-cert-manager</a> over to <a href="https://github.com/jetstack/cert-manager">cert-manager</a> means creating the certificate request as below and removing the annotations from the ingress. However, the safe way would be to;</p>
<ul>
<li>Create a new Certificate resource and point to a <strong>new</strong> secret name <em>(thus keeping the old one incase)</em>.</li>
<li>Push out the change and wait for the certificate to be fulfilled.</li>
<li>Once you have the certificate you can update your ingress to use the new secret,<strong>remove</strong> the annotations and use the Certificate resource thereafter.</li>
</ul>
<h3 id="as-a-developer-i-want-to-retrieve-an-internal-certificate"><strong>As a developer I want to retrieve an internal certificate</strong><a class="headerlink" href="#as-a-developer-i-want-to-retrieve-an-internal-certificate" title="Permanent link">#</a></h3>
<p>As stated above the cert-manager can also handle internal certificates i.e. those signed by the internal ACP Certificate Authority <em>(this is self signed btw)</em>. At the moment you might be using <a href="https://github.com/UKHomeOffice/cfssl-sidekick">cfssl-sidekick</a> to perform this, but this can be completely replaced.</p>
<p>If you want to create a certificate for a service, assuming the service is called <code>myservice</code> in namespace <code>mynamespace</code>, the Certificate definition would look like:</p>
<pre><code class="YAML">apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: tls
spec:
  secretName: tls
  issuerRef:
    name: platform-ca
    kind: ClusterIssuer
  dnsNames:
  - myservice
  - myservice.mynamespace
  - myservice.mynamespace.svc
  - myservice.mynamespace.svc.cluster.local
  - localhost
  ipAddresses:
  - 127.0.0.1
</code></pre>

<p>Ingress resources are checked by admission policies to ensure the platform-ca cluster issuer only issues certificates for DNS names that are hosted inside the namespace.</p>
<p>So if you want to create a certificate for a replica in a statefulset, assuming your statufelset is called <code>mysts</code>, the Certificate definition would look like:</p>
<pre><code class="YAML">apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: tls
spec:
  secretName: tls
  issuerRef:
    name: platform-ca
    kind: ClusterIssuer
  dnsNames:
  - mysts-0.myservice.mynamespace
  - mysts-0.myservice.mynamespace.svc
  - mysts-0.myservice.mynamespace.svc.cluster.local
  - localhost
  ipAddresses:
  - 127.0.0.1
</code></pre>

<p>Note that <code>mysts-0.myservice</code> is intentionally missing from the list in <code>dnsNames</code> because those names need to be either a hostname (for the service) or a name ending with <code>mynamespace</code>, <code>mynamespace.svc</code> or <code>mynamespace.svc.cluster.local</code>.</p>
<p>This would create a kubernetes secret named <code>tls</code> in your namespace with the signed certificate. An interesting thing to note here is that although this is using the ClusterIssuer platform-ca created by the ACP team, there is nothing stopping a project from creating a local Issuer for their own project. So for example.</p>
<pre><code class="YAML">---
apiVersion: cert-manager.io/v1alpha2
kind: Issuer
metadata:
  name: project-ca
spec:
  ca:
    secretName: project-ca
---
apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: tls
spec:
  secretName: tls
  issuerRef:
    name: project-ca
    # @Note: we have change from ClusterIssuer to a local Issuer
    kind: Issuer
  commonName: site.svc.project.cluster.local
  dnsNames:
  - localhost
  ipAddresses:
  - 127.0.0.1
</code></pre>

<p>Finally, if you want to use your certificate for client auth (as well as server auth in the following example), you need to add a <code>keyUsages</code> section to your Certificate resource:</p>
<pre><code class="YAML">apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: tls
spec:
  secretName: tls
  issuerRef:
    name: platform-ca
    kind: ClusterIssuer
  keyUsages:
  - server auth
  - client auth
  dnsNames:
  - myservice
  - myservice.mynamespace
  - myservice.mynamespace.svc
  - myservice.mynamespace.svc.cluster.local
  - localhost
  ipAddresses:
  - 127.0.0.1
</code></pre>

<h3 id="as-a-developer-i-want-to-retrieve-a-certificate-for-my-external-service"><strong>As a developer I want to retrieve a certificate for my external service</strong><a class="headerlink" href="#as-a-developer-i-want-to-retrieve-a-certificate-for-my-external-service" title="Permanent link">#</a></h3>
<p>Let's assume we have an externally facing site which we wish to expose via ingress and we want a valid LetsEncrypt certificate.</p>
<p>Getting a certificate associated with the external ingress only requires to annotate the ingress with <code>cert-manager.io/enabled</code>, which is a toggle to ask cert-manager to handle this ingress resource.</p>
<p>Optionally, the acme solver to be used by the cluster issuer can be specified with label <code>cert-manager.io/solver: http01</code>. However, this is not required as the <code>http01</code> acme solver is the default one.</p>
<p>Please note that <code>cert-manager.io/enabled</code> is an annotation but <code>cert-manager.io/solver</code> is a label.</p>
<p>When the site is externally facing i.e. the ingress class on the ingress is <code>kubernetes.io/ingress.class: nginx-external</code> you should always default to using a http01 challenge. However, if you know that the domain whitelisted in your namespace is hosted in AWS by Route53, you can instead specify a label of <code>cert-manager.io/solver: route53</code></p>
<pre><code class="YAML">apiVersion: networking.k8s.io/v1beta1
  kind: Ingress
  metadata:
    annotations:
      # @NOTE: this will enable cert-manager to handle this resource
      cert-manager.io/enabled: &quot;true&quot;
      ingress.kubernetes.io/affinity: cookie
      ingress.kubernetes.io/force-ssl-redirect: &quot;true&quot;
      ingress.kubernetes.io/backend-protocol: &quot;HTTPS&quot;
      ingress.kubernetes.io/session-cookie-name: ingress
      ingress.kubernetes.io/ssl-redirect: &quot;true&quot;
      kubernetes.io/ingress.class: nginx-external
    name: example
  # @NOTE: the following label can be specified to ask letsencrypt to use the http01 acme challenge
  # @NOTE: but it is not required as http01 is the default solver
  labels:
    cert-manager.io/solver: http01

  spec:
    rules:
    - host: www.example.com
      http:
        paths:
        - backend:
            serviceName: service_name
            servicePort: 10443
          path: /
    tls:
    - hosts:
      - www.example.com
      # @NOTE: this is the name of the kubernetes secret that cert-manager will manage in your namespace
      secretName: example-tls
</code></pre>

<p>A few things to note here:</p>
<ul>
<li>behind the scenes, cert-manager works with the <code>Certificate</code> custom resource.</li>
<li>when using ingress annotations and labels, cert-manager uses another internal controller to pick up the ingress resources and create a <code>Certificate</code> resource on your behalf. Of course, you can instead define this directly yourself but you will also have to define annotations on the ingress resource to specify which secret should be used for TLS termination. This is the recommended and safest approach when migrating from <code>kube-cert-manager</code> to <code>cert-manager</code>.</li>
</ul>
<pre><code class="YAML">apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: example
spec:
  commonName: www.example.com
  dnsNames:
  - www.example.com
  issuerRef:
    kind: ClusterIssuer
    # @Note: we support letsencrypt-prod and letsencrypt-staging (use the latter to test your cert-manager related manifests)
    name: letsencrypt-prod
  secretName: example-tls
</code></pre>

<p>You can review, get, list and describe the Certificate like any other kubernetes resource within your namespace.</p>
<pre><code class="shell">$ kubectl -n project get certificate
NAME        AGE
example-tls    1d

# you can also review the certificaterequests, orders and challenges via
$ kubectl -n project get orders
$ kubectl -n project get challenge
</code></pre>

<p><strong>Network Policies</strong></p>
<p>Please note that as part of the implementation of cert-manager v0.13.1, a <code>GlobalNetworkPolicy</code> object managing ingress traffic for <code>http01</code> challenges has been deployed.</p>
<p>This means that you no longer need to have a <code>NetworkPolicy</code> in your namespaces allowing ingress traffic from port 8089 to the ephemeral pods that cert-manager creates to handle the <code>http01</code> challenge.</p>
<h3 id="as-a-developer-i-want-to-retrieve-a-certificate-for-a-service-behind-the-vpn-or-simply-wish-to-use-the-dns-validation"><strong>As a developer I want to retrieve a certificate for a service behind the vpn, or simply wish to use the DNS validation</strong><a class="headerlink" href="#as-a-developer-i-want-to-retrieve-a-certificate-for-a-service-behind-the-vpn-or-simply-wish-to-use-the-dns-validation" title="Permanent link">#</a></h3>
<p>When a site is internal / behind the vpn, in order to handle the challenge you need to switch to using a DNS challenge.</p>
<p>This is done by adding the following to your ingress resource:</p>
<ul>
<li>annotation <code>cert-manager.io/enabled: "true"</code></li>
<li>label <code>cert-manager.io/solver: route53</code></li>
</ul>
<p><strong>Very Important</strong>: in order to successfully switch to a DNS challenge, please ensure you have contacted the ACP team before attempting this for the first time on your sub-domain as the correct permissions need to exist to permit cert-manager to add records to the domain.</p>
<pre><code class="YAML">apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: example-tls
  labels:
    # @Note: this label tells the cluster issuer to use the DNS01 Route53 solver instead of the default HTTP01 solver
    cert-manager.io/solver: route53
spec:
  secretName: example-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  commonName: mysite.example.com
  dnsNames:
  - example.com
  acme:
    config:
    - dns01:
        provider: route53
      domains:
      - mysite.example.com
      - example.com
</code></pre>

<p>Or via ingress you would use</p>
<pre><code class="YAML">apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: example
  annotations:
    # @Note: get cert-manager to manage this ingress
    cert-manager.io/enabled: &quot;true&quot;
    kubernetes.io/ingress.class: nginx-internal
  labels:
    # @Note: this label tells the cluster issuer to use the DNS01 Route53 solver instead of the default HTTP01 solver
    cert-manager.io/solver: route53
spec:
  rules:
  - host: mysite.example.com
    http:
      paths:
      - backend:
          serviceName: service_name
          servicePort: 443
        path: /
  tls:
  - hosts:
    - mysite.example.com
    - example.com
    secretName: example-tls
</code></pre>

<h3 id="as-a-developer-i-want-to-use-letsencrypt-staging-while-configuring-my-cert-manager-resources"><strong>As a developer I want to use LetsEncrypt staging while configuring my cert-manager resources</strong><a class="headerlink" href="#as-a-developer-i-want-to-use-letsencrypt-staging-while-configuring-my-cert-manager-resources" title="Permanent link">#</a></h3>
<p>You should use the staging version of LetsEncrypt in order to not be impacted by rate limits of the production version while setting up and testing the cert-manager annotations and labels you specify on your resources.</p>
<p>By default, the production version of the LetsEncrypt ACME servers is used.</p>
<p>To use the staging version, use the <code>cert-manager.io/cluster-issuer</code> annotation:</p>
<pre><code class="YAML">apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: example
  annotations:
    cert-manager.io/enabled: &quot;true&quot;
    kubernetes.io/ingress.class: nginx-internal
    # @Note: we are specifying which cluster issuer to use
    cert-manager.io/cluster-issuer: letsencrypt-staging
labels:
    cert-manager.io/solver: route53
spec:
  rules:
  - host: mysite.example.com
    http:
      paths:
      - backend:
          serviceName: service_name
          servicePort: 443
        path: /
  tls:
  - hosts:
    - mysite.example.com
    - example.com
    secretName: example-tls
</code></pre>

<p>Not specifying this annotation is equivalent to specifying <code>cert-manager.io/cluster-issuer: letsencrypt-prod</code>.</p>
<p>Please note that the certificates issued by the staging version of LetsEncrypt are not signed and should not be used in production.</p>
<h3 id="as-a-developer-i-want-to-get-a-certificate-for-a-server-with-a-dns-name-longer-than-63-characters"><strong>As a developer I want to get a certificate for a server with a DNS name longer than 63 characters</strong><a class="headerlink" href="#as-a-developer-i-want-to-get-a-certificate-for-a-server-with-a-dns-name-longer-than-63-characters" title="Permanent link">#</a></h3>
<p>A certificate's <code>commonName</code> is used to create a Certificate Signing Request and populate a field that is limited to 63 characters.</p>
<p>In order to get a certificate for a server with a DNS name longer than 63 characters, you need to specify a common name of less than 63 characters and add the desired DNS name as an additional entry to <code>dnsNames</code>.</p>
<p>For example, with an <code>Ingress</code>:</p>
<pre><code class="YAML">apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: example
  annotations:
    cert-manager.io/enabled: &quot;true&quot;
    kubernetes.io/ingress.class: nginx-internal
  labels:
    cert-manager.io/solver: route53
spec:
  rules:
  - host: my-rather-long-winded-service-name.my-namespace.subdomain.example.com
    http:
      paths:
      - backend:
          serviceName: service_name
          servicePort: 443
        path: /
  tls:
  - hosts:
    - svc-1.my-namespace.subdomain.example.com
    - my-rather-long-winded-service-name.my-namespace.subdomain.example.com
    secretName: example-tls
</code></pre>

<p>Or with a <code>Certificate</code>:</p>
<pre><code class="YAML">apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: example
spec:
  secretName: example-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  commonName: svc-1.my-namespace.subdomain.example.com
  dnsNames:
  - svc-1.my-namespace.subdomain.example.com
  - my-rather-long-winded-service-name.my-namespace.subdomain.example.com
</code></pre>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.22b62ea4.min.js"></script>
      <script src="../assets/javascripts/bundle.5f27aba8.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.f6ebf1dc.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>