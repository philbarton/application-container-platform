


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.1.7">
    
    
      
        <title>Drone how to - Application Container Platform</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4c7052ca.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#drone-how-to" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Application Container Platform" class="md-header-nav__button md-logo" aria-label="Application Container Platform">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Application Container Platform
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Drone how to
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Application Container Platform" class="md-nav__button md-logo" aria-label="Application Container Platform">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Application Container Platform
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../index.html" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../services.html" title="Services" class="md-nav__link">
      Services
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://gitlab.digital.homeoffice.gov.uk/acp-docs/acp-support/tree/master/release-notes/" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="index.html" title="How To's" class="md-nav__link">
      How To's
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../developer-docs/index.html" title="Developer Getting Started Guide" class="md-nav__link">
      Developer Getting Started Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../newuser.html" title="New User Guide" class="md-nav__link">
      New User Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../rbac.html" title="RBAC Guide" class="md-nav__link">
      RBAC Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../external-addresses.html" title="ACP External IPs" class="md-nav__link">
      ACP External IPs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../service-lifecycle.html" title="Service Lifecycle" class="md-nav__link">
      Service Lifecycle
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#drone-how-to" class="md-nav__link">
    Drone How To
  </a>
  
    <nav class="md-nav" aria-label="Drone How To">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-drone-cli" class="md-nav__link">
    Install Drone CLI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#activate-your-pipeline" class="md-nav__link">
    Activate your pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-your-pipeline" class="md-nav__link">
    Configure your pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#publishing-docker-images" class="md-nav__link">
    Publishing Docker images
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deployments" class="md-nav__link">
    Deployments
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-another-repo" class="md-nav__link">
    Using Another Repo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#versioned-deployments" class="md-nav__link">
    Versioned deployments
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#migrating-your-pipeline" class="md-nav__link">
    Migrating your pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-in-docker" class="md-nav__link">
    Docker-in-Docker
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#services" class="md-nav__link">
    Services
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variable-escaping" class="md-nav__link">
    Variable Escaping
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scanning-images-in-drone" class="md-nav__link">
    Scanning Images in Drone
  </a>
  
    <nav class="md-nav" aria-label="Scanning Images in Drone">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#qas" class="md-nav__link">
    Q&amp;As
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                  <h1>Drone how to</h1>
                
                <h2 id="drone-how-to">Drone How To<a class="headerlink" href="#drone-how-to" title="Permanent link">#</a></h2>
<h4 id="install-drone-cli">Install Drone CLI<a class="headerlink" href="#install-drone-cli" title="Permanent link">#</a></h4>
<ul>
<li>Github drone instance: https://drone.acp.homeoffice.gov.uk/</li>
<li>Gitlab drone instance: https://drone-gitlab.acp.homeoffice.gov.uk/</li>
</ul>
<p>Download and install the <a href="https://0-8-0.docs.drone.io/cli-installation/">Drone CLI</a>.</p>
<blockquote>
<p>At the time of writing, we are using version 0.8 of Drone.</p>
</blockquote>
<p>You can also install a release from <a href="https://github.com/drone/drone-cli/releases">Drone CLI's GitHub repo</a>.
Once you have downloaded the relevant file, extract it and move it to the <code>/usr/local/bin</code> directory.</p>
<p>Verify it works as expected:</p>
<pre><code class="bash">$ drone --version
drone version 0.8.0
</code></pre>

<p>Export the <code>DRONE_SERVER</code> and <code>DRONE_TOKEN</code> variables. You can find your token on Drone by clicking the icon in the top right corner and going to <a href="https://drone.acp.homeoffice.gov.uk/account/token">Token</a>.</p>
<pre><code class="bash">export DRONE_SERVER=https://drone.acp.homeoffice.gov.uk
export DRONE_TOKEN=&lt;your_drone_token&gt;
</code></pre>

<p>If your installation is successful, you should be able to query the current Drone instance:</p>
<pre><code class="bash">$ drone info
User: youruser
Email: youremail@gmail.com
</code></pre>

<blockquote>
<p>If the output is</p>
<p><code>bash
Error: you must provide the Drone server address.</code></p>
<p>or</p>
<p><code>Error: you must provide your Drone access token.</code></p>
<p>Please make sure that you have exported the <code>DRONE_SERVER</code> and <code>DRONE_TOKEN</code> variables properly.</p>
</blockquote>
<h4 id="activate-your-pipeline">Activate your pipeline<a class="headerlink" href="#activate-your-pipeline" title="Permanent link">#</a></h4>
<p>Once you are logged in to Drone, you will find a list of repos by clicking the icon in the top right corner and going to <a href="https://drone.acp.homeoffice.gov.uk/account/repos">Repositories</a>.</p>
<p>Sync your repository access rights with Drone by clicking the icon in the top right corner again with the <code>Synchronize</code> button - this needs to be applied everytime when a new repository is created.</p>
<p>Select the repo you want to activate.</p>
<p>Navigate to your repository's settings in Github (or Gitlab) and you will see a webhook has been created. You need to update the url for the newly created web hook so that it matches this pattern:</p>
<pre><code>https://drone-external.acp.homeoffice.gov.uk/hook?access_token=some_token
</code></pre>

<blockquote>
<p>If it is already in that format there is no need to change anything.</p>
<p>The token in the payload url will not be the same as the personal token that you exported and it should be left unchanged.</p>
<p><strong>Please note that this does not apply to Gitlab. When you activate the repo in Drone, you should not change anything for a Gitlab repo.</strong></p>
</blockquote>
<h4 id="configure-your-pipeline">Configure your pipeline<a class="headerlink" href="#configure-your-pipeline" title="Permanent link">#</a></h4>
<p>In the root folder of your project, create a <code>.drone.yml</code> file with the following content:</p>
<pre><code class="yaml">pipeline:

  my-build:
    image: docker:18.03
    environment:
      - DOCKER_HOST=tcp://172.17.0.1:2375
    commands:
      - docker build -t &lt;image_name&gt; .
    when:
      branch: master
      event: push
</code></pre>

<p>Commit and push your changes:</p>
<pre><code class="bash">$ git add .drone.yml
$ git commit
$ git push origin master
</code></pre>

<blockquote>
<p><strong>Please note</strong> you should replace the name &lt;...&gt; with the name of your app.</p>
</blockquote>
<p>You should be able to watch your build succeed in the Drone UI.</p>
<h4 id="publishing-docker-images">Publishing Docker images<a class="headerlink" href="#publishing-docker-images" title="Permanent link">#</a></h4>
<h5>Publishing to Quay</h5>
<p>If your repository is hosted on Gitlab, you don't want to publish your images to Quay. Images published to Quay are public and can be inspected and downloaded by anyone. <a href="#publishing-to-artifactory">You should publish your private images to Artifactory</a>.</p>
<p>Register for a free <a href="https://quay.io">Quay account</a> using your Github account linked to the Home Office organisation.</p>
<p>Once you've logged into Quay check that you have <code>ukhomeofficedigital</code> under Users and Organisations.
If you do not, <a href="https://support.acp.homeoffice.gov.uk/servicedesk/customer/portal/1/create/88">submit a support request on the support portal for access to the ukhomeoffice organisation</a>.</p>
<p>Once you have access to view the <code>ukhomeofficedigital</code> repositories, click repositories and
click the <code>+ Create New Repositories</code> that is:</p>
<ul>
<li>public</li>
<li>empty - no need to create a repo from a Dockerfile or link it to an existing repository</li>
</ul>
<p>Add your project to the UKHomeOffice Quay account and <a href="https://support.acp.homeoffice.gov.uk/servicedesk/customer/portal/1/create/37">submit a support request on the support portal for a new Quay robot</a>.</p>
<p>Add the step to publish the docker image to Quay in your Drone pipeline:</p>
<pre><code class="yaml">image_to_quay:
  image: quay.io/ukhomeofficedigital/drone-docker
  secrets:
    - docker_password
  environment:
    - DOCKER_USERNAME=ukhomeofficedigital+&lt;your_robot_username&gt;
  registry: quay.io
  repo: quay.io/ukhomeofficedigital/&lt;your_quay_repo&gt;
  tags:
    - ${DRONE_COMMIT_SHA}
    - latest
  when:
    branch: master
    event: push
</code></pre>

<p>Where <code>&lt;your_quay_repo&gt;</code> in:</p>
<pre><code class="yaml">quay.io/ukhomeofficedigital/&lt;your_quay_repo&gt;
</code></pre>

<p>is the name of the Quay repo you (should) have already created.</p>
<blockquote>
<p>Note: ${DRONE_COMMIT_SHA} is a Drone environment variable that is passed to the container at runtime.</p>
</blockquote>
<p>The build should fail with the following error:</p>
<pre><code class="bash">Error response from daemon: Get https://quay.io/v2/: unauthorized: Could not find robot with username: ukhomeofficedigital+&lt;your_robot_username&gt; and supplied password.
</code></pre>

<p>The error points to the missing password for the Quay robot. You will need to add this as a drone secret.</p>
<p>You can do this through the Drone UI by going to your repo, clicking the menu icon in the top right and then clicking <strong>Secrets</strong>. You should be presented with a list of the secrets for that repo (if there are any) and you should be able to add secrets giving them a name and value. Add a secret with the name <code>DOCKER_PASSWORD</code> and with the value being the robot token that was supplied to you.</p>
<p>Alternatively, you can use the Drone CLI to add the secret:</p>
<pre><code>$ drone secret add --repository ukhomeoffice/&lt;your_github_repo&gt; --name DOCKER_PASSWORD --value &lt;your_robot_token&gt;
</code></pre>

<p>Restarting the build should be enough to make it pass.</p>
<blockquote>
<p>The Drone CLI allows for more control over the secret as opposed to the UI. For example, the CLI allows you to specify the image and the events that the secret will be allowed to be used with.</p>
<p>Also note that the secret was specified in the <code>secrets</code> section of the pipeline to give it access to the secret. Without this, the pipeline would not be able to use the secret and it would fail. Secrets in this section are automatically uppercased at runtime so it is important that the secret is uppercased in your commands.</p>
</blockquote>
<p>You can also push specifically tagged images by using the <code>DRONE_TAG</code> Drone environment variable and by using the <code>tag</code> event:</p>
<pre><code class="yaml">tagged_image_to_quay:
  image: quay.io/ukhomeofficedigital/drone-docker
  secrets:
    - docker_password
  environment:
    - DOCKER_USERNAME=ukhomeofficedigital+&lt;your_robot_username&gt;
  registry: quay.io
  repo: quay.io/ukhomeofficedigital/&lt;your_quay_repo&gt;
  tags:
    - ${DRONE_TAG}
  when:
    event: tag
</code></pre>

<p>Tag using <code>git tag v1.0</code> and push your tag with <code>git push origin v1.0</code> (replace <code>v1.0</code> with the tag you actually want to use).</p>
<blockquote>
<p>Note: These pipeline configurations are using the Docker plugin for Drone. For more information, see http://plugins.drone.io/drone-plugins/drone-docker/</p>
</blockquote>
<h5>Publishing to Artifactory</h5>
<p>Images hosted on <a href="https://docker.digital.homeoffice.gov.uk">Artifactory</a> are private.</p>
<p>If your repository is hosted publicly on GitHub, you shouldn't publish your images to Artifactory. Artifactory is only used to publish private images. <a href="#publishing-to-quay">You should use Quay to publish your public images</a>.</p>
<p><a href="https://support.acp.homeoffice.gov.uk/servicedesk/customer/portal/1/create/30">Submit a support request for a new Artifactory access token</a>. You should be supplied an access token in response.</p>
<p>You can inject the token that has been supplied to you with:</p>
<pre><code>$ drone secret add --repository &lt;gitlab_repo_group&gt;/&lt;your_gitlab_repo&gt; --name DOCKER_PASSWORD --value &lt;your_robot_token&gt;
</code></pre>

<p>You can add the following step in your <code>.drone.yml</code>:</p>
<pre><code class="yaml">image_to_artifactory:
  image: quay.io/ukhomeofficedigital/drone-docker
  secrets:
    - docker_password
  environment:
    - DOCKER_USERNAME=&lt;your_robots_username&gt;
  registry: docker.digital.homeoffice.gov.uk
  repo: docker.digital.homeoffice.gov.uk/&lt;your_artifactory_repo&gt;
  tags:
    - ${DRONE_COMMIT_SHA}
    - latest
  when:
    branch: master
    event: push
</code></pre>

<p>Where the <code>&lt;image_name&gt;</code> in:</p>
<pre><code class="yaml">docker tag &lt;image_name&gt; docker.digital.homeoffice.gov.uk/ukhomeofficedigital/&lt;your_artifactory_repo&gt;:$${DRONE_COMMIT_SHA}
</code></pre>

<p>is the name of the image you tagged previously in the build step.</p>
<p>The image should now be published on Artifactory. Please note that we regularly remove container images that have not been downloaded in a year.</p>
<h4 id="deployments">Deployments<a class="headerlink" href="#deployments" title="Permanent link">#</a></h4>
<h5>Deployments and promotions</h5>
<p>Create a step that runs only on deployments:</p>
<pre><code class="yaml">deploy-to-preprod:
  image: busybox
  commands:
    - /bin/echo hello preprod
  when:
    environment: preprod
    event: deployment
</code></pre>

<p>Push the changes to your remote repository.</p>
<p>You can deploy the build you just pushed with the following command:</p>
<pre><code class="bash">$ drone deploy ukhomeoffice/&lt;your_repo&gt; 16 preprod
</code></pre>

<p>Where <code>16</code> is the successful build number on drone that you wish to deploy to the <code>preprod</code> environment.</p>
<p>You can pass additional parameters to your deployment as environment variables:</p>
<pre><code class="bash">$ drone deploy ukhomeoffice/&lt;your_repo&gt; 16 preprod -p DEBUG=1 -p NAME=Dan
</code></pre>

<p>and use them in the step like this:</p>
<pre><code class="yaml">deploy-to-preprod:
  image: busybox
  commands:
    - /bin/echo hello $${NAME}
  when:
    environment: preprod
    event: deployment
</code></pre>

<p>Environments are strings and can be set to any value. When you wish to deploy to several environments you can create a step for each one of them:</p>
<pre><code class="yaml">deploy-to-preprod:
  image: busybox
  commands:
    - /bin/echo hello preprod
  when:
    environment: preprod
    event: deployment

deploy-to-prod:
  image: busybox
  commands:
    - /bin/echo hello prod
  when:
    environment: prod
    event: deployment
</code></pre>

<p>And deploy them accordingly:</p>
<pre><code class="bash">$ drone deploy ukhomeoffice/&lt;your_repo&gt; 16 preprod
$ drone deploy ukhomeoffice/&lt;your_repo&gt; 16 prod
</code></pre>

<p>Read more on <a href="http://0-8-0.docs.drone.io/environment/">environments</a>.</p>
<h5>Drone as a Pull Request builder</h5>
<p>Drone pipelines are triggered when events occurs. Event triggers can be as simple as a <em>push</em>, <em>a tagged commit</em>, <em>a pull request</em> or as granular as <em>only for pull requests for a branch named <code>test</code></em>. You can limit the execution of build steps at runtime using the <code>when</code> block. As an example, this block executes only on pull requests:</p>
<pre><code class="yaml">pr-builder:
  image: docker:18.03
  environment:
    - DOCKER_HOST=tcp://172.17.0.1:2375
  commands:
    - docker build -t &lt;image_name&gt; .
  when:
    event: pull_request
</code></pre>

<p>Drone will only execute that step when a new pull request is raised (and when pushes are made to the branch while a pull request is open).</p>
<p><a href="http://0-8-0.docs.drone.io/step-conditions/">Read more about Drone conditions</a>.</p>
<h5>Deploying to ACP</h5>
<blockquote>
<p>Please note that this section assumes that you already have kube files to work with (specifically, deployment, service and ingress files).
Examples of these files can be found in the <a href="https://github.com/UKHomeOffice/kube-signed-commit-check">kube-signed-commit-check</a> project.</p>
</blockquote>
<p>Add a deployment script with the following:</p>
<pre><code class="bash">#!/bin/bash
export KUBE_NAMESPACE=&lt;dev-induction&gt;
export KUBE_SERVER=${KUBE_SERVER}
export KUBE_TOKEN=${KUBE_TOKEN}

kd  -f deployment.yaml \
    -f service.yaml \
    -f ingress.yaml
</code></pre>

<blockquote>
<p>Please note that this is only an example script and it will need to be changed to fit your particular application's needs.</p>
</blockquote>
<p>If you deployed this now you would likely receive an error similar to this:</p>
<pre><code class="bash">error: You must be logged in to the server (the server has asked for the client to provide credentials)
</code></pre>

<p>This error appears because <a href="https://github.com/UKHomeOffice/kd">kd</a> needs 3 environment variables to be set before deploying:</p>
<ul>
<li>
<p><code>KUBE_NAMESPACE</code> - The kubernetes namespace you wish to deploy to. <strong>You need to provide the kubernetes namespace as part of the deployment job</strong>.</p>
</li>
<li>
<p><code>KUBE_TOKEN</code> - This is the token used to authenticate against the kubernetes cluster. <strong>If you do not already have a kube token, <a href="kubernetes-user-token.html">here are docs explaining how to get one</a></strong>.</p>
</li>
<li>
<p><code>KUBE_SERVER</code> - This is the address of the kubernetes cluster that you want to deploy to.</p>
</li>
</ul>
<p>You will need to add <code>KUBE_TOKEN</code> and <code>KUBE_SERVER</code> as drone secrets. Information about how to add Drone secrets can be found in the <a href="#publishing-to-quay">publishing to Quay section</a>.</p>
<p>You can verify that the secrets for your repo are present with:</p>
<pre><code class="bash">$ drone secret ls --repository ukhomeoffice/&lt;your-repo&gt;
</code></pre>

<p>Once the secrets have been added, add a new step to your drone pipeline that will execute the deployment script:</p>
<pre><code class="yaml">deploy_to_uat:
  image: quay.io/ukhomeofficedigital/kd:v0.11.0
  secrets:
    - kube_server
    - kube_token
  commands:
    - ./deploy.sh
  when:
    environment: uat
    event: deployment
</code></pre>

<h4 id="using-another-repo">Using Another Repo<a class="headerlink" href="#using-another-repo" title="Permanent link">#</a></h4>
<p>It is possible to access files or deployment scripts from another repo, there are two ways of doing this.</p>
<p>The recommended method is to clone another repo in the current repo (since this only requires maintaining one .drone.yml) using the following step:</p>
<pre><code class="yaml">predeploy_to_uat:
  image: plugins/git
  commands:
    - git clone https://${GITHUB_TOKEN}:x-oauth-basic@github.com/UKHomeOffice/&lt;your_repo&gt;.git
  when:
    environment: uat
    event: deployment
</code></pre>

<p>Your repository is saved in the workspace, which in turn is shared among all steps in the pipeline.</p>
<p>However, if you decide that you want to trigger a completely different pipeline on a separate repository, you can leverage the <a href="https://github.com/UKHomeOffice/drone-trigger">drone-trigger</a> plugin. If you have a secondary repository, you can setup Drone on that repository like so:</p>
<pre><code class="yaml">pipeline:
  deploy_to_uat:
    image: busybox
    commands:
      - echo ${SHA}
    when:
      event: deployment
      environment: uat
</code></pre>

<p>Once you are ready, you can push the changes to the remote repository. In your main repository you can add the following step:</p>
<pre><code class="yaml">trigger_deploy:
  image: quay.io/ukhomeofficedigital/drone-trigger:latest
  drone_server: https://drone.acp.homeoffice.gov.uk
  repo: UKHomeOffice/&lt;deployment_repo&gt;
  branch: &lt;master&gt;
  deploy_to: &lt;uat&gt;
  params: SHA=${DRONE_COMMIT_SHA}
  when:
    event: deployment
    environment: uat
</code></pre>

<p>The settings are very similar to the <code>drone deploy</code> command:</p>
<ul>
<li><code>deploy_to</code> is the <a href="http://0-8-0.docs.drone.io/step-conditions/#environment">environment constraint</a></li>
<li><code>params</code> is a list of comma separated list of arguments. In the command line tool, this is equivalent to <code>-p PARAM1=ONE -p PARAM2=TWO</code></li>
<li><code>repo</code> the repository where the deployment scripts are located</li>
</ul>
<p>The next time you trigger a deployment on the main repository with:</p>
<pre><code class="bash">$ drone deploy UKHomeOffice/&lt;your_repo&gt; 16 uat
</code></pre>

<p>This will trigger a new deployment on the second repository.</p>
<p>Please note that in this scenario you need to inspect 2 builds on 2 separate repositories if you just want to inspect the logs.</p>
<h4 id="versioned-deployments">Versioned deployments<a class="headerlink" href="#versioned-deployments" title="Permanent link">#</a></h4>
<p>When you restart your build, Drone will automatically use the latest version of the code. However always using the latest version of the deployment configuration can cause major issues and isn't recommended. For example when promoting from preprod to prod you want to use the preprod version of the deployment configuration. If you use the latest it could potentially break your production environment, especially as it won't necessarily have been tested.</p>
<p>To counteract this you should use a specific version of your deployment scripts. In fact, you should  <code>git checkout</code> the tag or sha as part of your deployment step.</p>
<p>Here is an example of this:</p>
<pre><code class="yaml">predeploy_to_uat:
  image: plugins/git
  commands:
    - git clone https://${GITHUB_TOKEN}:x-oauth-basic@github.com/UKHomeOffice/&lt;your_repo&gt;.git
  when:
    environment: uat
    event: deployment

deploy_to_uat:
  image: quay.io/ukhomeofficedigital/kd:v0.11.0
  secrets:
    - kube_server
    - kube_token
  commands:
    - apk update &amp;&amp; apk add git
    - git checkout v1.1
    - ./deploy.sh
  when:
    environment: uat
    event: deployment
</code></pre>

<h4 id="migrating-your-pipeline">Migrating your pipeline<a class="headerlink" href="#migrating-your-pipeline" title="Permanent link">#</a></h4>
<h5>Secrets and Signing</h5>
<p>It is no longer necessary to sign your <code>.drone.yml</code> so the <code>.drone.yml.sig</code> can be deleted. Secrets can be defined in the Drone UI or using the CLI. Secrets created using the UI will be available to push, tag and deployment events. To restrict to selected events, or to allow pull request builds to access secrets you must use the CLI.</p>
<p>Pipelines by default do not have access to any Drone secrets that you have added. You must now define which secrets a pipeline is allowed access to in a <code>secrets</code> section in your pipeline. Here is an example of a pipeline that has access to the <code>DOCKER_PASSWORD</code> secret which will be used to push an image to Quay:</p>
<pre><code class="yaml">image_to_quay:
  image: quay.io/ukhomeofficedigital/drone-docker
  secrets:
    - docker_password
  environment:
    - DOCKER_USERNAME=ukhomeofficedigital+&lt;your_robot_username&gt;
  registry: quay.io
  repo: quay.io/ukhomeofficedigital/&lt;your_quay_repo&gt;
  tags:
    - latest
  when:
    branch: master
    event: push
</code></pre>

<blockquote>
<p>Note: Secrets names in the <code>secrets</code> section will have their names uppercased at runtime.</p>
</blockquote>
<p>Organisation secrets are no longer available. This means that if you are using any organisation secrets such as <code>KUBE_TOKEN_DEV</code>, you will need to add a secret in Drone to replace it.</p>
<h4 id="docker-in-docker">Docker-in-Docker<a class="headerlink" href="#docker-in-docker" title="Permanent link">#</a></h4>
<p>The Docker-in-Docker (dind) service is no longer required. Instead, change the Docker host to <code>DOCKER_HOST=tcp://172.17.0.1:2375</code> in the <code>environment</code> section of your pipline, and you will be able to access the shared Docker server on the drone agent. Note that it is only possible to run one Docker build at a time per Drone agent.</p>
<p>Since privileged mode was primarily used for docker in docker, you should remove the <code>privileged: true</code> line from your <code>.drone.yml</code>.</p>
<p>You can also use your freshly built image directly and run commands as part of your pipeline.</p>
<p>Example:</p>
<pre><code class="yaml">pipeline:

  build_image:
    image: docker:18.03
    environment:
      - DOCKER_HOST=tcp://172.17.0.1:2375
    commands:
      - docker build -t hello_world .
    when:
      branch: master
      event: push

  test_image:
    image: hello_world
    commands:
      - ./run-hello-world.sh
    when:
      branch: master
      event: push
</code></pre>

<h4 id="services">Services<a class="headerlink" href="#services" title="Permanent link">#</a></h4>
<p>If you use the <code>services</code> section of your <code>.drone.yml</code> it is possible to reference them using the DNS name of the service.</p>
<p>For example, if using the following section:</p>
<pre><code class="yaml">services:
  database:
    image: mysql
</code></pre>

<p>The mysql server would be available on <code>tcp://database:3306</code></p>
<h4 id="variable-escaping">Variable Escaping<a class="headerlink" href="#variable-escaping" title="Permanent link">#</a></h4>
<p>Any Drone variables (secrets and environment variables) must now be escaped by having two $$ instead of one. Examples:</p>
<pre><code class="yaml">${DOCKER_PASSWORD} --&gt; $${DOCKER_PASSWORD}
${DRONE_TAG} --&gt; $${DRONE_TAG}
${DRONE_COMMIT_SHA} --&gt; $${DRONE_COMMIT_SHA}

</code></pre>

<h2 id="scanning-images-in-drone">Scanning Images in Drone<a class="headerlink" href="#scanning-images-in-drone" title="Permanent link">#</a></h2>
<p>ACP provides Anchore as a scanning solution for images built into the Drone pipeline, allowing users to scan both ephemeral <em>(built within the context of the drone, but not pushed to a repository yet)</em> as well as any public images.</p>
<p>Example pipeline:</p>
<pre><code class="YAML">pipeline:
  build:
    image: docker:17.09.0-ce
    environment:
    - DOCKER_HOST=tcp://172.17.0.1:2375
    commands:
    - docker build -t docker.digital.homeoffice.gov.uk/myimage:$${DRONE_BUILD_NUMBER} .

  scan:
    # The location of the drone plugin
    image: quay.io/ukhomeofficedigital/anchore-submission:latest
    # The optional path of a Dockerfile
    dockerfile: Dockerfile
    # Note the lack of double $ here (due to the way drone injects variables)
    image_name: docker.digital.homeoffice.gov.uk/myimage:${DRONE_BUILD_NUMBER}
    # Indicates the image is locally available
    local_image: true
    # This indicates we are willing tolerate any vulnerabilities which are below medium (valid values: negligible, low, medium, high, critical)
    tolerate: medium
    # An optional whitelist (comma separated list of CVE's)
    whitelist: CVE_SOMENAME_1,CVE_SOMENAME_2
    # An optional whitelist file containing a list of CSV relative to the repo path
    whitelist_file: &lt;PATH&gt;
    # Indicates we should show all vulnerabilities regardless
    show_all_vulnerabilities: false
    # By default the plugin will exit will fail if any vulnerabilities are discovered which are not tolerated,
    # you change this behaviour by setting the below
    fail_on_detection: false
</code></pre>

<h4 id="qas">Q&amp;As<a class="headerlink" href="#qas" title="Permanent link">#</a></h4>
<h5>Q: The build fails with <em>"ERROR: Insufficient privileges to use privileged mode"</em></h5>
<p>A: Remove <code>privileged: true</code> from your <code>.drone.yml</code>. As explained in the <a href="#migrating-your-pipeline">migrating your pipeline section</a>, the primary use of this was for Docker-in-Docker which is not required.</p>
<h5>Q: The build fails with <em>"Cannot connect to the Docker daemon. Is the docker daemon running on this host?"</em></h5>
<p>A: Make sure that your steps contain the environment variable <code>DOCKER_HOST=tcp://172.17.0.1:2375</code> like in this case:</p>
<pre><code class="yaml">my-build:
  image: docker:18.03
  environment:
    - DOCKER_HOST=tcp://172.17.0.1:2375
  commands:
    - docker build -t &lt;image_name&gt; .
  when:
    branch: master
    event: push
</code></pre>

<h5>Q: The build fails when uploading to Quay with the error <em>"Error response from daemon: Get https://quay.io/v2/: unauthorized:..."</em></h5>
<p>A: This is likely because the secret wasn't added correctly or the password is incorrect. Check that the secret has been added to Drone and that you have added the <code>secrets</code> section in your <code>.drone.yaml</code> it to the pipeline that requires it.</p>
<h5>Q: As part of my build process I have two <code>Dockerfiles</code> to produce a Docker image. How can I share files between builds in the same step?</h5>
<p>A: When the pipeline starts, Drone creates a Docker data volume that is passed along all active steps in the pipeline. If the first step creates a <code>test.txt</code> file, the second step can use that file. As an example, this pipeline uses a two step build process:</p>
<pre><code class="yaml">pipeline:

  first-step:
    image: busybox
    commands:
      - echo hello &gt; test.txt
    when:
      branch: master
      event: push

  second-step:
    image: busybox
    commands:
      - cat test.txt
    when:
      branch: master
      event: push
</code></pre>

<h5>Q: Should I use Gitlab with Quay?</h5>
<p>A: Please don't. If your repository is hosted in Gitlab then use Artifactory to publish your images. Images published to Artifactory are kept private.</p>
<p>If you still want to use Quay, you should consider hosting your repository on the open (Github).</p>
<h5>Q: Can I create a token that has permission to create ephemeral/temporary namespaces?</h5>
<p>A: No. This is because there is currently no way to give access to namespaces via regex.</p>
<p>I.e. There is no way to give access to any namespace with the format: <code>my-temp-namespace-*</code> (where * would be build number or something similar).</p>
<p>Alternatively, you can be given a named namespace in the CI cluster. Please create an issue on our <a href="https://support.acp.homeoffice.gov.uk/servicedesk">Support Portal</a> if you require this.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.22b62ea4.min.js"></script>
      <script src="../assets/javascripts/bundle.5f27aba8.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.f6ebf1dc.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>